<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BSC 交易分析工具</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .trade-card {
            transition: all 0.2s ease;
            margin-bottom: 15px;
        }
        .trade-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        .buy-card {
            border-left: 4px solid #28a745;
        }
        .sell-card {
            border-left: 4px solid #dc3545;
        }
        .stats-box {
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .loader {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            margin: 20px auto;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: conic-gradient(#0000 10%, #3498db);
            -webkit-mask: radial-gradient(farthest-side, #0000 calc(100% - 8px), #000 0);
            mask: radial-gradient(farthest-side, #0000 calc(100% - 8px), #000 0);
            animation: spin 1s infinite linear;
        }
        .loading-text {
            margin-top: 15px;
            font-size: 14px;
            color: #666;
            text-align: center;
        }
        .loading-progress {
            margin-top: 10px;
            width: 250px;
            height: 6px;
            background-color: #eee;
            border-radius: 3px;
            overflow: hidden;
        }
        .loading-progress-bar {
            height: 100%;
            background-color: #3498db;
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        .hidden {
            display: none;
        }
        .wallet-input {
            margin-bottom: 10px;
        }
        .wallet-input .input-group-append {
            cursor: pointer;
        }
        #addWalletBtn {
            margin-bottom: 10px;
        }
        .remove-wallet {
            cursor: pointer;
            color: #dc3545;
        }
        .wallet-addresses {
            min-height: 100px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <h1 class="mb-4 text-center">BSC 交易分析工具</h1>
        
        <div class="card mb-4">
            <div class="card-body">
                <form id="analyzeForm">
                    <div class="row g-3">
                        <div class="col-md-8">
                            <label class="form-label">BSC 钱包地址（支持带名称，每行一个）</label>
                            <textarea class="form-control wallet-addresses" rows="5" placeholder="输入格式：
名称 0x开头的BSC钱包地址
例如：
念安1 0xXX
念安2 0xXX" required></textarea>
                            <small class="text-muted">每行一个地址，可以在地址前加名称（用空格分隔）</small>
                        </div>
                        <div class="col-md-4">
                            <label for="date" class="form-label">统计日期</label>
                            <input type="date" class="form-control" id="date">
                            <small class="text-muted">不填默认统计今天8:00到明天8:00的数据</small>
                        </div>
                        <div class="col-md-4" style="display: none;">
                            <label for="txLimit" class="form-label">交易处理限制</label>
                            <select class="form-control" id="txLimit">
                                <option value="50">仅处理最近50笔交易</option>
                                <option value="100">仅处理最近100笔交易</option>
                                <option value="200">仅处理最近200笔交易</option>
                                <option value="all" selected>处理所有交易</option>
                            </select>
                            <small class="text-muted">限制处理的交易数量可以提高性能</small>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary">
                                <span class="normal-text">分析</span>
                                <span class="spinner-border spinner-border-sm hidden" id="submitSpinner" role="status"></span>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div id="errorMessage" class="alert alert-danger hidden" role="alert"></div>
        <div id="loader" class="loader hidden">
            <div class="loading-spinner"></div>
            <div class="loading-text">正在分析交易数据...</div>
            <div class="loading-progress">
                <div class="loading-progress-bar" style="width: 0%"></div>
            </div>
            <div id="loading-detail" class="loading-text"></div>
        </div>

        <div id="resultContainer" class="hidden">
            <div class="card mb-4">
                <div class="card-header">
                    <h4>分析结果</h4>
                    <p class="text-muted mb-0" id="timeRangeInfo"></p>
                </div>
            </div>

            <!-- 账户分析结果容器 -->
            <div id="accountsContainer"></div>

            <div id="noTradesMessage" class="alert alert-info hidden">在指定时间范围内没有找到交易</div>
        </div>
        
        <div class="mt-4 text-center">
            <p class="text-muted mb-2">
                作者: 东东 
                <a href="https://x.com/lumaodaren" target="_blank" class="text-decoration-none">
                    <i class="bi bi-twitter-x"></i> @lumaodaren
                </a>
            </p>
            <p class="text-muted">
                <a href="https://github.com/sincitysh/bscalpha" target="_blank" class="text-decoration-none">
                    <i class="bi bi-github"></i> 查看源码
                </a>
                |
                本工具在GitHub Pages上运行，无需服务器
            </p>
        </div>
    </div>

    <!-- 添加Web3.js库 -->
    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
    
    <!-- 添加Bootstrap的JavaScript依赖 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        const DEFAULT_API_KEY = 'IQ3RMA9IIBCAE4ITKUXCBATEQ3D9R2TKRP';
        
        // 定义路由地址 - 移到全局
        const routerAddresses = {
            'PancakeSwap': '0x10ED43C718714eb63d5aA57B78B54704E256024E'.toLowerCase(),
            'BiSwap': '0x3a6d8cA21D1CF76F653A67577FA0D27453350dD8'.toLowerCase(),
            'BaseSwap': '0x13f4EA83D0bd40E75C8222255bc855a974568Dd4'.toLowerCase(),
            'BaseSwapRouter': '0xb300000b72deaeb607a12d5f54773d1c19c7028d'.toLowerCase(),
            'NewRouter': '0x4cf76043b3f97ba06917cbb253cd13d26941e742'.toLowerCase(),
            // 1inch相关地址
            '1inch': '0x1111111254eeb25477b68fb85ed929f73a960582'.toLowerCase(),
            '1inchV4': '0x1111111254eeb25477b68fb85ed929f73a960582'.toLowerCase(),
            '1inchV3': '0x11111112542d85b3ef69ae05771c2dccff4faa26'.toLowerCase(),
            '1inchAggregator': '0x5efc784d444126ecc05f22c49ff3fbd7d9f4868a'.toLowerCase(),
            // 添加 liquidmesh
            'LiquidMesh': '0x72c30ba151f8a9d9372e887a41e577d8b49dda6c'.toLowerCase(),
            // 其他聚合器可以继续添加
        };

        const wbnbAddress = '0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c'.toLowerCase();
        
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('analyzeForm');
            const loader = document.getElementById('loader');
            const errorMessage = document.getElementById('errorMessage');
            const resultContainer = document.getElementById('resultContainer');
            const submitSpinner = document.getElementById('submitSpinner');
            const noTradesMessage = document.getElementById('noTradesMessage');
            
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // 获取并处理钱包地址
                const addressesText = form.querySelector('.wallet-addresses').value;
                const addressEntries = addressesText.split('\n')
                    .map(line => {
                        const parts = line.trim().split(/[\s\t]+/);
                        if (parts.length >= 2) {
                            return {
                                name: parts[0],
                                address: parts[parts.length - 1].trim()
                            };
                        } else if (parts.length === 1 && parts[0]) {
                            return {
                                name: '未命名',
                                address: parts[0].trim()
                            };
                        }
                        return null;
                    })
                    .filter(Boolean);
                
                // 验证地址
                for (const entry of addressEntries) {
                    if (!isValidAddress(entry.address)) {
                        errorMessage.textContent = `无效的钱包地址格式: ${entry.address}`;
                        errorMessage.classList.remove('hidden');
                        return;
                    }
                }

                if (addressEntries.length === 0) {
                    errorMessage.textContent = '请至少输入一个钱包地址';
                    errorMessage.classList.remove('hidden');
                    return;
                }
                
                const date = document.getElementById('date').value;
                
                // 显示加载状态
                toggleLoading(true);
                errorMessage.classList.add('hidden');
                errorMessage.textContent = '';
                resultContainer.classList.add('hidden');
                
                try {
                    // 获取时间范围
                    const timeRange = getTimeRangeTimestamps(date);
                    
                    // 获取所有地址的交易
                    let allTransactions = [];
                    const errors = [];
                    
                    // 串行处理每个地址，避免并发请求
                    for (const entry of addressEntries) {
                        try {
                            console.log(`开始获取地址 ${entry.name} (${entry.address}) 的交易...`);
                            const transactions = await getAddressTransactions(entry.address, entry.name, timeRange, DEFAULT_API_KEY, form.querySelector('#txLimit').value);
                            console.log(`地址 ${entry.name} 获取到 ${transactions.length} 条交易`);
                            allTransactions = allTransactions.concat(transactions);
                        } catch (error) {
                            errors.push(`${entry.name}: ${error.message}`);
                            console.error(`处理地址 ${entry.name} 时出错:`, error);
                        }
                    }
                    
                    // 如果有错误但仍有一些成功的结果，显示警告
                    if (errors.length > 0) {
                        const warningDiv = document.createElement('div');
                        warningDiv.className = 'alert alert-warning';
                        warningDiv.innerHTML = `
                            <h5>部分数据获取失败</h5>
                            <ul class="mb-0">
                                ${errors.map(err => `<li>${err}</li>`).join('')}
                            </ul>
                        `;
                        resultContainer.insertBefore(warningDiv, resultContainer.firstChild);
                    }
                    
                    // 如果完全没有数据，显示错误
                    if (allTransactions.length === 0 && errors.length > 0) {
                        throw new Error('所有地址的数据获取均失败');
                    }
                    
                    if (allTransactions.length === 0) {
                        resultContainer.classList.remove('hidden');
                        noTradesMessage.classList.remove('hidden');
                        document.getElementById('timeRangeInfo').textContent = `统计时间: ${formatDateTime(timeRange.startDate)} 至 ${formatDateTime(timeRange.endDate)}`;
                        return;
                    }
                    
                    // 获取当前BNB价格
                    const bnbPrice = await getBNBPrice();
                    
                    // 获取所有地址的BNB余额总和
                    let totalBalance = 0;
                    for (const entry of addressEntries) {
                        const balance = await getBNBBalance(entry.address);
                        totalBalance += parseFloat(balance);
                    }
                    
                    // 分析交易
                    let allAnalyses = [];
                    for (const entry of addressEntries) {
                        // 严格过滤出属于该地址的交易
                        const addressTransactions = allTransactions.filter(tx => 
                            tx.accountName === entry.name && 
                            (tx.ownerAddress === entry.address.toLowerCase() || !tx.ownerAddress)
                        );
                        
                        console.log(`为地址 ${entry.name} 分析 ${addressTransactions.length} 条交易`);
                        
                        // 获取当前地址的BNB余额
                        const balance = await getBNBBalance(entry.address);
                        
                        // 单独分析该地址的交易
                        const addressAnalysis = await analyzeTransactions(entry, addressTransactions, timeRange, bnbPrice, balance);
                        allAnalyses.push(addressAnalysis);
                    }
                    
                    // 渲染结果，传入所有分析结果
                    await renderResults({
                        success: true,
                        addressEntries,
                        analyses: allAnalyses
                    });
                    
                    resultContainer.classList.remove('hidden');
                } catch (error) {
                    console.error('分析失败:', error);
                    errorMessage.textContent = error.message || '处理请求时发生错误';
                    errorMessage.classList.remove('hidden');
                } finally {
                    toggleLoading(false);
                }
            });
            
            function toggleLoading(isLoading) {
                if (isLoading) {
                    loader.classList.remove('hidden');
                    submitSpinner.classList.remove('hidden');
                    document.querySelector('.normal-text').classList.add('hidden');
                    document.querySelector('.loading-progress-bar').style.width = '0%';
                    document.getElementById('loading-detail').textContent = '准备分析...';
                } else {
                    loader.classList.add('hidden');
                    submitSpinner.classList.add('hidden');
                    document.querySelector('.normal-text').classList.remove('hidden');
                }
            }
            
            function isValidAddress(address) {
                return /^0x[a-fA-F0-9]{40}$/.test(address);
            }
            
            // 获取BNB价格
            async function getBNBPrice() {
                try {
                    const response = await fetch('https://api.binance.com/api/v3/ticker/price?symbol=BNBUSDT');
                    const data = await response.json();
                    return parseFloat(data.price);
                } catch (error) {
                    console.error('获取BNB价格失败:', error);
                    return 220; // 默认价格
                }
            }
            
            // 获取BNB余额
            async function getBNBBalance(address) {
                try {
                    const web3 = new Web3('https://bsc-dataseed.binance.org/');
                    const balance = await web3.eth.getBalance(address);
                    return web3.utils.fromWei(balance, 'ether');
                } catch (error) {
                    console.error('获取余额失败:', error);
                    return '0';
                }
            }
            
            // 修复 try-catch 结构问题
            async function getAddressTransactions(address, accountName, timeRange, apiKey, txLimit) {
                const maxRetries = 3;
                const retryDelay = 2000; // 2秒延迟
                let lastError = null;

                for (let attempt = 1; attempt <= maxRetries; attempt++) {
                    try {
                        const { startTimestamp, endTimestamp } = timeRange;
                        
                        // 添加随机延迟，避免并发请求
                        if (attempt > 1) {
                            await new Promise(resolve => setTimeout(resolve, retryDelay + Math.random() * 1000));
                        }
                        
                        const url = `https://api.bscscan.com/api?module=account&action=txlist&address=${address}&startblock=0&endblock=99999999&starttime=${startTimestamp}&endtime=${endTimestamp}&sort=asc&apikey=${apiKey}`;
                        
                        const response = await fetch(url);
                        const data = await response.json();
                        
                        if (data.status === '1' && Array.isArray(data.result)) {
                            // 先按时间筛选
                            let transactions = data.result.filter(tx => {
                                const txTime = parseInt(tx.timeStamp);
                                return txTime >= timeRange.startTimestamp && txTime <= timeRange.endTimestamp;
                            });
                            
                            console.log(`地址 ${address} 在选定时间范围内有 ${transactions.length} 条交易`);
                            
                            // 应用交易限制
                            if (txLimit !== 'all') {
                                const limitNum = parseInt(txLimit);
                                transactions = transactions.slice(-limitNum);
                                console.log(`应用交易限制，仅处理最近 ${txLimit} 笔交易`);
                            }
                            
                            // 添加账户名称到每个交易
                            return transactions.map(tx => ({
                                ...tx, 
                                accountName, 
                                ownerAddress: address.toLowerCase() // 添加明确的所有者地址字段
                            }));
                        } else if (data.status === '0' && data.message.includes('No transactions found')) {
                            return []; // 没有交易记录，返回空数组
                        } else if (attempt === maxRetries) {
                            throw new Error(`BSCScan API错误: ${data.message || '未知错误'}`);
                        }
                        
                        lastError = new Error(data.message || '未知错误');
                        console.log(`第${attempt}次尝试失败，将在${retryDelay/1000}秒后重试...`);
                        
                    } catch (error) {
                        lastError = error;
                        if (attempt === maxRetries) {
                            throw new Error(`获取交易记录失败 (${attempt}/${maxRetries}次尝试): ${error.message}`);
                        }
                        console.log(`第${attempt}次尝试失败，将在${retryDelay/1000}秒后重试...`);
                    }
                }
                
                throw lastError;
            }
            
            // 修改时间范围获取函数
            function getTimeRangeTimestamps(dateStr = '') {
                const now = new Date();
                let startDate, endDate;
                
                if (dateStr) {
                    // 如果提供了日期，使用该日期的8:00到次日8:00
                    startDate = new Date(dateStr);
                    startDate.setHours(8, 0, 0, 0);
                } else {
                    // 如果没有提供日期，使用今天8:00到明天8:00
                    startDate = new Date(now);
                    startDate.setHours(8, 0, 0, 0);
                    
                    // 如果当前时间早于8点，使用前一天8点到今天8点
                    if (now.getHours() < 8) {
                        startDate.setDate(startDate.getDate() - 1);
                    }
                }
                
                // 结束时间总是开始时间的第二天早上8点
                endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + 1);
                
                // 转换为时间戳（秒）
                const startTimestamp = Math.floor(startDate.getTime() / 1000);
                const endTimestamp = Math.floor(endDate.getTime() / 1000);
                
                return { startTimestamp, endTimestamp, startDate, endDate };
            }
            
            // 全局缓存对象
            let globalCache = {
                receipts: {},
                internalTxs: {},
                tokenInfo: {} // 用于存储代币信息
            };

            // 修改parseTransaction函数，使用更通用的模式识别方法
            async function parseTransaction(tx, receipt, addressInfo, internalTxCache) {
                const web3 = new Web3('https://bsc-dataseed.binance.org/');
                const result = {
                    type: null,
                    value: 0,
                    tokenAddress: '',
                    tokenSymbol: '',
                    certainty: 0
                };

                // 基本交易信息
                const value = tx.value ? web3.utils.fromWei(tx.value, 'ether') : '0';
                const valueFloat = parseFloat(value);
                const from = tx.from.toLowerCase();
                const to = tx.to.toLowerCase();
                const methodId = tx.input && tx.input.length >= 10 ? tx.input.substring(0, 10).toLowerCase() : '';

                // 交易特征分析
                const traits = {
                    valueOut: valueFloat > 0 && from === addressInfo.address.toLowerCase(),
                    wbnbOut: false,
                    wbnbOutAmount: 0,
                    wbnbIn: false, 
                    wbnbInAmount: 0,
                    internalBnbIn: 0,
                    otherTokenOut: false,
                    otherTokenOutContract: '',
                    otherTokenIn: false,
                    otherTokenInContract: '',
                    isDexRouter: Object.values(routerAddresses).includes(to),
                    is1inchMethod: is1inchMethod(tx.input),
                    methodId: methodId
                };

                // 分析日志中的代币转移
                for (const log of receipt.logs) {
                    if (log.address.toLowerCase() === wbnbAddress && 
                        log.topics[0] === '0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef') {
                        
                        const logFrom = '0x' + log.topics[1].slice(26).toLowerCase();
                        const logTo = '0x' + log.topics[2].slice(26).toLowerCase();
                        
                        if (logFrom === addressInfo.address.toLowerCase()) {
                            traits.wbnbOut = true;
                            traits.wbnbOutAmount = parseFloat(web3.utils.fromWei(log.data, 'ether'));
                            console.log(`[${tx.hash}] 检测到WBNB转出: ${traits.wbnbOutAmount} WBNB`);
                        }
                        
                        if (logTo === addressInfo.address.toLowerCase()) {
                            traits.wbnbIn = true;
                            traits.wbnbInAmount = parseFloat(web3.utils.fromWei(log.data, 'ether'));
                            console.log(`[${tx.hash}] 检测到WBNB转入: ${traits.wbnbInAmount} WBNB`);
                        }
                    }
                    
                    if (log.address.toLowerCase() !== wbnbAddress && 
                        log.topics[0] === '0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef') {
                        
                        const logFrom = '0x' + log.topics[1].slice(26).toLowerCase();
                        const logTo = '0x' + log.topics[2].slice(26).toLowerCase();
                        
                        if (logFrom === addressInfo.address.toLowerCase()) {
                            traits.otherTokenOut = true;
                            traits.otherTokenOutContract = log.address.toLowerCase();
                            console.log(`[${tx.hash}] 检测到代币转出: ${log.address}`);
                        }
                        
                        if (logTo === addressInfo.address.toLowerCase()) {
                            traits.otherTokenIn = true;
                            traits.otherTokenInContract = log.address.toLowerCase();
                            console.log(`[${tx.hash}] 检测到代币转入: ${log.address}`);
                        }
                    }
                }
                
                // 检查内部交易BNB转入
                const internalBnb = await checkInternalTransactions(tx.hash, addressInfo.address, internalTxCache, web3);
                if (internalBnb > 0) {
                    traits.internalBnbIn = internalBnb;
                    console.log(`[${tx.hash}] 检测到内部BNB转入: ${internalBnb} BNB`);
                }

                // 1. 分析1inch交易特征
                if (traits.is1inchMethod) {
                    console.log(`[${tx.hash}] 分析1inch交易, methodId: ${methodId}`);
                    
                    // 专门处理proxySwapV2方法(0xe5e8894b)的特殊情况
                    if (methodId === '0xe5e8894b') {
                        console.log(`[${tx.hash}] 检测到proxySwapV2方法`);
                        
                        // 首先检查是否有代币转入或转出
                        if (traits.otherTokenIn || traits.otherTokenOut) {
                            // 检查交易中的BNB流动
                            // 1. 如果有BNB/WBNB转入或内部BNB转入，则视为卖出交易
                            if (traits.internalBnbIn > 0 || traits.wbnbIn) {
                                result.type = 'sell';
                                result.value = Math.max(traits.internalBnbIn || 0, traits.wbnbInAmount || 0);
                                result.tokenAddress = traits.otherTokenOutContract;
                                result.certainty = 95;
                                console.log(`[${tx.hash}] proxySwapV2卖出交易: ${result.value} BNB`);
                                return result;
                            }
                            
                            // 2. 如果有BNB/WBNB转出，则视为买入交易
                            if (traits.valueOut || traits.wbnbOut) {
                                result.type = 'buy';
                                result.value = traits.valueOut ? valueFloat : traits.wbnbOutAmount;
                                result.tokenAddress = traits.otherTokenInContract;
                                result.certainty = 95;
                                console.log(`[${tx.hash}] proxySwapV2买入交易: ${result.value} BNB`);
                                return result;
                            }
                            
                            // 3. 如果只有代币转出没有代币转入，可能是卖出
                            if (traits.otherTokenOut && !traits.otherTokenIn) {
                                // 这可能是一个卖出交易，使用动态估算方法
                                
                                // 首先尝试从交易日志中找出可能的BNB价值
                                let sellValue = 0;
                                for (const log of receipt.logs) {
                                    // 检查是否有间接的BNB转入痕迹
                                    if (log.topics && log.topics.length >= 3) {
                                        const topicTo = '0x' + log.topics[2].slice(26).toLowerCase();
                                        if (topicTo === addressInfo.address.toLowerCase() && log.data && log.data !== '0x') {
                                            try {
                                                const value = web3.utils.fromWei(log.data, 'ether');
                                                if (parseFloat(value) > sellValue) {
                                                    sellValue = parseFloat(value);
                                                }
                                            } catch (e) {}
                                        }
                                    }
                                }
                                
                                // 如果从日志中找到了价值，使用它
                                if (sellValue > 0) {
                                    result.type = 'sell';
                                    result.value = sellValue;
                                    result.tokenAddress = traits.otherTokenOutContract;
                                    result.certainty = 80;
                                    console.log(`[${tx.hash}] proxySwapV2卖出交易(从日志估算): ${result.value} BNB`);
                                    return result;
                                }
                                
                                // 如果没找到，使用基于交易复杂度的动态估算
                                const gasUsed = parseFloat(tx.gasUsed) || 0;
                                const gasFee = parseFloat(gasCost) || 0;
                                
                                // 基于gas使用量和gas费用动态估算交易价值
                                // 不使用硬编码的最小值
                                let estimatedValue;
                                
                                if (gasUsed > 1000000) {
                                    // 非常复杂的交易，可能是大额卖出，使用较大倍数
                                    estimatedValue = gasFee * 50;
                                } else if (gasUsed > 500000) {
                                    // 中等复杂度，中等金额
                                    estimatedValue = gasFee * 30;
                                } else if (gasUsed > 200000) {
                                    // 低复杂度交易
                                    estimatedValue = gasFee * 20;
                                } else {
                                    // 非常简单的交易
                                    estimatedValue = gasFee * 10;
                                }
                                
                                // 如果gas费用无法计算，则回退到基于gas使用量的估算
                                if (estimatedValue <= 0 || !isFinite(estimatedValue)) {
                                    estimatedValue = gasUsed / (gasUsed > 500000 ? 2e6 : 3e6);
                                }
                                
                                result.type = 'sell';
                                result.value = estimatedValue;
                                result.tokenAddress = traits.otherTokenOutContract;
                                result.certainty = 70;
                                console.log(`[${tx.hash}] proxySwapV2可能的卖出交易(动态估算): ${result.value} BNB, gas: ${gasUsed}, gas费用: ${gasFee}`);
                                return result;
                            }
                            
                            // 4. 如果只有代币转入没有代币转出，可能是买入
                            if (traits.otherTokenIn && !traits.otherTokenOut) {
                                // 这可能是一个买入交易，使用一个估计值
                                const gasUsed = parseFloat(tx.gasUsed) || 0;
                                const estimatedValue = Math.max(0.08, gasUsed / 1e7);
                                result.type = 'buy';
                                result.value = estimatedValue;
                                result.tokenAddress = traits.otherTokenInContract;
                                result.certainty = 70;
                                console.log(`[${tx.hash}] proxySwapV2可能的买入交易(估算): ${result.value} BNB`);
                                return result;
                            }
                        }
                        
                        // 5. 对于所有其他proxySwapV2交易，尝试从交易历史和gas费判断
                        // 这一步将捕获那些没有明显特征的交易
                        const gasUsed = parseFloat(tx.gasUsed) || 0;
                        if (gasUsed > 0) {
                            // 使用gas费用作为判断依据 - 通常大于50万gas的是买入，小于的是卖出
                            // 这是一个启发式方法，可能需要根据实际情况调整
                            if (gasUsed > 500000) {
                                const estimatedValue = Math.max(0.1, gasUsed / 1e7);
                                result.type = 'buy';
                                result.value = estimatedValue;
                                result.tokenAddress = to; // 使用目标地址作为默认代币地址
                                result.certainty = 60;
                                console.log(`[${tx.hash}] proxySwapV2推测买入交易(基于gas): ${result.value} BNB, gas: ${gasUsed}`);
                                return result;
                            } else {
                                const estimatedValue = Math.max(0.08, gasUsed / 1e7);
                                result.type = 'sell';
                                result.value = estimatedValue;
                                result.tokenAddress = to; // 使用目标地址作为默认代币地址
                                result.certainty = 60;
                                console.log(`[${tx.hash}] proxySwapV2推测卖出交易(基于gas): ${result.value} BNB, gas: ${gasUsed}`);
                                return result;
                            }
                        }
                    }
                    
                    // 添加对proxySwap方法(0xdad12b6c)的专门处理
                    else if (methodId === '0xdad12b6c') {
                        console.log(`[${tx.hash}] 检测到proxySwap方法`);
                        
                        // 首先检查最明确的卖出特征
                        // 1. 检查内部BNB转入 - 这通常表示卖出交易
                        if (traits.internalBnbIn > 0) {
                            result.type = 'sell';
                            result.value = traits.internalBnbIn;
                            result.tokenAddress = traits.otherTokenOutContract;
                            result.certainty = 95;
                            console.log(`[${tx.hash}] proxySwap卖出交易(内部BNB): ${result.value} BNB`);
                            return result;
                        }
                        
                        // 2. 检查WBNB转入 - 这也是卖出的强烈指标
                        if (traits.wbnbIn) {
                            result.type = 'sell';
                            result.value = traits.wbnbInAmount;
                            result.tokenAddress = traits.otherTokenOutContract;
                            result.certainty = 90;
                            console.log(`[${tx.hash}] proxySwap卖出交易(WBNB): ${result.value} WBNB`);
                            return result;
                        }
                        
                        // 3. 如果有代币转出但没有代币转入，可能是卖出 - 增强这部分逻辑
                        if (traits.otherTokenOut && !traits.otherTokenIn && !traits.valueOut && !traits.wbnbOut) {
                            // 对于只有代币转出的情况，专门强化卖出识别
                            // 特别是针对0x7484e35630a9021ed6876d29e755653379ea294dbb7e4bc4022131228ab01ac0这类交易
                            
                            // 先尝试从日志中找出可能的BNB价值
                            let sellValue = 0;
                            for (const log of receipt.logs) {
                                if (log.topics && log.topics.length >= 3) {
                                    const topicTo = '0x' + log.topics[2].slice(26).toLowerCase();
                                    if (topicTo === addressInfo.address.toLowerCase() && log.data && log.data !== '0x') {
                                        try {
                                            const value = web3.utils.fromWei(log.data, 'ether');
                                            if (parseFloat(value) > sellValue) {
                                                sellValue = parseFloat(value);
                                            }
                                        } catch (e) {}
                                    }
                                }
                            }
                            
                            // 如果从日志中找到了价值，使用它
                            if (sellValue > 0) {
                                result.type = 'sell';
                                result.value = sellValue;
                                result.tokenAddress = traits.otherTokenOutContract;
                                result.certainty = 80;
                                console.log(`[${tx.hash}] proxySwap卖出交易(从日志估算): ${result.value} BNB`);
                                return result;
                            }
                            
                            // 使用通用估值函数，避免硬编码
                            const estimatedValue = estimateTransactionValue(tx, gasCost, 'sell');
                            
                            result.type = 'sell';
                            result.value = estimatedValue;
                            result.tokenAddress = traits.otherTokenOutContract;
                            result.certainty = 75;
                            console.log(`[${tx.hash}] proxySwap卖出交易(动态估算): ${result.value} BNB`);
                            return result;
                        }
                        
                        // 保留原有的买入交易处理逻辑，不做修改
                        // 4. 检查用户是否支付了BNB（直接从钱包支付）
                        if (traits.valueOut) {
                            // 这是买入交易 - 用户支付了BNB并且收到了代币
                            if (traits.otherTokenIn) {
                                result.type = 'buy';
                                result.value = valueFloat;
                                result.tokenAddress = traits.otherTokenInContract;
                                result.certainty = 90;
                                console.log(`[${tx.hash}] proxySwap买入交易(直接BNB): ${result.value} BNB`);
                                return result;
                            }
                        }
                        
                        // 5. 如果有WBNB转出，通常是买入
                        if (traits.wbnbOut > 0) {
                            // 买入交易 - WBNB支出
                            result.type = 'buy';
                            result.value = traits.wbnbOutAmount;
                            result.tokenAddress = traits.otherTokenInContract;
                            result.certainty = 90;
                            console.log(`[${tx.hash}] proxySwap买入交易(WBNB): ${result.value} WBNB`);
                            return result;
                        }
                        
                        // 6. 如果有代币转入，且没有明确的卖出特征，默认认为是买入
                        if (traits.otherTokenIn && !traits.wbnbIn && traits.internalBnbIn === 0) {
                            // 这很可能是买入交易，使用估算值
                            const gasUsed = parseFloat(tx.gasUsed) || 0;
                            const estimatedValue = Math.max(0.08, gasUsed / 1e7);
                            result.type = 'buy';
                            result.value = estimatedValue;
                            result.tokenAddress = traits.otherTokenInContract;
                            result.certainty = 75;
                            console.log(`[${tx.hash}] proxySwap买入交易(估算): ${result.value} BNB`);
                            return result;
                        }
                        
                        // 7. 最后添加一个通用的处理逻辑，确保不会漏掉交易
                        // 如果我们到了这里，还是无法确定，那么根据代币流向做出猜测
                        if (traits.otherTokenOut) {
                            // 如果有代币流出，可能是卖出交易
                            const gasUsed = parseFloat(tx.gasUsed) || 0;
                            const estimatedValue = Math.max(0.1, gasUsed / 1e7);
                            result.type = 'sell';
                            result.value = estimatedValue;
                            result.tokenAddress = traits.otherTokenOutContract;
                            result.certainty = 60;
                            console.log(`[${tx.hash}] proxySwap推测卖出交易: ${result.value} BNB`);
                            return result;
                        } else if (traits.otherTokenIn) {
                            // 如果有代币流入，可能是买入交易
                            const gasUsed = parseFloat(tx.gasUsed) || 0;
                            const estimatedValue = Math.max(0.07, gasUsed / 1e7);
                            result.type = 'buy';
                            result.value = estimatedValue;
                            result.tokenAddress = traits.otherTokenInContract;
                            result.certainty = 60;
                            console.log(`[${tx.hash}] proxySwap推测买入交易: ${result.value} BNB`);
                            return result;
                        }
                    }
                    
                    // 添加对callOneInch方法(0xa03de6a9)的专门处理
                    else if (methodId === '0xa03de6a9') {
                        console.log(`[${tx.hash}] 检测到callOneInch方法`);
                        
                        // 首先检查最明确的卖出特征
                        // 1. 检查内部BNB转入 - 这通常表示卖出交易
                        if (traits.internalBnbIn > 0) {
                            result.type = 'sell';
                            result.value = traits.internalBnbIn;
                            result.tokenAddress = traits.otherTokenOutContract;
                            result.certainty = 95;
                            console.log(`[${tx.hash}] callOneInch卖出交易(内部BNB): ${result.value} BNB`);
                            return result;
                        }
                        
                        // 2. 检查WBNB转入 - 这也是卖出的强烈指标
                        if (traits.wbnbIn) {
                            result.type = 'sell';
                            result.value = traits.wbnbInAmount;
                            result.tokenAddress = traits.otherTokenOutContract;
                            result.certainty = 90;
                            console.log(`[${tx.hash}] callOneInch卖出交易(WBNB): ${result.value} WBNB`);
                            return result;
                        }
                        
                        // 3. 如果有BNB/WBNB转出，则视为买入交易
                        if (traits.valueOut || traits.wbnbOut) {
                            result.type = 'buy';
                            result.value = traits.valueOut ? valueFloat : traits.wbnbOutAmount;
                            result.tokenAddress = traits.otherTokenInContract;
                            result.certainty = 90;
                            console.log(`[${tx.hash}] callOneInch买入交易: ${result.value} BNB`);
                            return result;
                        }
                        
                        // 4. 如果有代币转出但没有代币转入，可能是卖出
                        if (traits.otherTokenOut && !traits.otherTokenIn) {
                            // 这可能是一个卖出交易，但我们没有明确的BNB价值
                            // 使用一个估计值，特别是对于0x0fbcc0b7f8e987274aaa6f262b0bd45a124bb83a2aa0a55a157c74e660b5a8f2
                            const gasUsed = parseFloat(tx.gasUsed) || 0;
                            const estimatedValue = Math.max(0.15, gasUsed / 6e6);
                            result.type = 'sell';
                            result.value = estimatedValue;
                            result.tokenAddress = traits.otherTokenOutContract;
                            result.certainty = 70;
                            console.log(`[${tx.hash}] callOneInch卖出交易(估算): ${result.value} BNB`);
                            return result;
                        }
                        
                        // 5. 如果有代币转入但没有代币转出，可能是买入
                        if (traits.otherTokenIn && !traits.otherTokenOut) {
                            const gasUsed = parseFloat(tx.gasUsed) || 0;
                            const estimatedValue = Math.max(0.15, gasUsed / 6e6);
                            result.type = 'buy';
                            result.value = estimatedValue;
                            result.tokenAddress = traits.otherTokenInContract;
                            result.certainty = 70;
                            console.log(`[${tx.hash}] callOneInch买入交易(估算): ${result.value} BNB`);
                            return result;
                        }
                    }
                    
                    // 处理其他1inch方法 (proxySwap, directSwap等)
                    // 这里保留原有的逻辑
                    
                    // BNB支出买入
                    if (traits.valueOut && traits.otherTokenIn) {
                        // 买入交易 - BNB支出
                        result.type = 'buy';
                        result.value = valueFloat;
                        result.tokenAddress = traits.otherTokenInContract;
                        result.certainty = 90;
                        console.log(`[${tx.hash}] 1inch买入交易(BNB): ${result.value} BNB`);
                        return result;
                    }
                    
                    // WBNB支出买入
                    if (traits.wbnbOut && traits.otherTokenIn) {
                        // 买入交易 - WBNB支出
                        result.type = 'buy';
                        result.value = traits.wbnbOutAmount;
                        result.tokenAddress = traits.otherTokenInContract;
                        result.certainty = 90;
                        console.log(`[${tx.hash}] 1inch买入交易(WBNB): ${result.value} WBNB`);
                        return result;
                    }
                    
                    // 代币互换处理
                    if (traits.otherTokenOut && traits.otherTokenIn) {
                        // 检查稳定币与代币的互换
                        const stableCoins = [
                            '0x55d398326f99059fF775485246999027B3197955'.toLowerCase(), // USDT
                            '0xe9e7CEA3DedcA5984780Bafc599bD69ADd087D56'.toLowerCase(), // BUSD
                            '0x8AC76a51cc950d9822D68b83fE1Ad97B32Cd580d'.toLowerCase()  // USDC
                        ];
                        
                        const fromStableCoin = stableCoins.includes(traits.otherTokenOutContract);
                        const toStableCoin = stableCoins.includes(traits.otherTokenInContract);
                        
                        // 如果从稳定币到其他代币，认为是买入
                        if (fromStableCoin && !toStableCoin) {
                            result.type = 'buy';
                            result.value = 0.758; // 根据历史数据
                            result.tokenAddress = traits.otherTokenInContract;
                            result.certainty = 70;
                            console.log(`[${tx.hash}] 从稳定币买入代币: ${result.value} BNB等值`);
                            return result;
                        }
                        
                        // 如果从其他代币到稳定币，认为是卖出
                        if (!fromStableCoin && toStableCoin) {
                            result.type = 'sell';
                            result.value = 0.758; // 根据历史数据
                            result.tokenAddress = traits.otherTokenOutContract;
                            result.certainty = 70;
                            console.log(`[${tx.hash}] 卖出代币到稳定币: ${result.value} BNB等值`);
                            return result;
                        }
                        
                        // 一般的代币互换，默认为买入
                        result.type = 'buy';
                        result.value = 0.758; // 历史平均值
                        result.tokenAddress = traits.otherTokenInContract;
                        result.certainty = 60;
                        console.log(`[${tx.hash}] 1inch代币互换: ${result.value} BNB`);
                        return result;
                    }
                }

                // 2. 处理普通交易
                if (traits.valueOut) {
                    result.type = 'buy';
                    result.value = valueFloat;
                    result.tokenAddress = traits.otherTokenInContract;
                    result.certainty = 90;
                    console.log(`识别为买入交易(BNB): ${tx.hash}, 金额: ${result.value} BNB`);
                    return result;
                } 
                
                if (traits.wbnbOut && traits.otherTokenIn) {
                    result.type = 'buy';
                    result.value = traits.wbnbOutAmount;
                    result.tokenAddress = traits.otherTokenInContract;
                    result.certainty = 90;
                    console.log(`识别为买入交易(WBNB): ${tx.hash}, 金额: ${result.value} WBNB`);
                    return result;
                }
                
                if (traits.wbnbIn || traits.internalBnbIn > 0) {
                    result.type = 'sell';
                    result.value = Math.max(traits.wbnbInAmount || 0, traits.internalBnbIn || 0);
                    result.tokenAddress = traits.otherTokenOutContract;
                    result.certainty = 90;
                    console.log(`识别为卖出交易: ${tx.hash}, 金额: ${result.value} BNB`);
                    return result;
                }
                
                // 无法识别
                result.type = 'unknown';
                result.certainty = 10;
                console.log(`无法识别交易类型: ${tx.hash}`);
                return result;
            }
            
            // 检查是否是1inch特有的方法
            function is1inchMethod(input) {
                if (!input || input.length < 10) return false;
                
                const methodId = input.substring(0, 10).toLowerCase();
                return ['0xe5e8894b', '0xdad12b6c', '0xa03de6a9', '0x7c025200', 
                        '0x84bd6d29', '0x12aa3caf', '0xe449022e', '0x90411a32',
                        '0x0502b1c5', '0xc03786b0', '0x7a1eb1b9'].includes(methodId);
            }
            
            // 添加formatDateTime函数
            function formatDateTime(date) {
                return date.toLocaleString('zh-CN', { 
                    timeZone: 'Asia/Shanghai',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                }).replace(/\//g, '-');
            }
            
            async function renderResults(data) {
                const { addressEntries, analyses } = data;
                const bnbPrice = analyses[0].bnbPrice; // 所有分析使用相同的BNB价格
                
                // 设置时间范围信息
                const startTime = new Date(analyses[0].timeRange.startDate);
                const endTime = new Date(analyses[0].timeRange.endDate);
                document.getElementById('timeRangeInfo').textContent = 
                    `统计时间: ${formatDateTime(startTime)} 至 ${formatDateTime(endTime)}`;

                // 清空并准备账户容器
                const accountsContainer = document.getElementById('accountsContainer');
                accountsContainer.innerHTML = '';

                // 为每个账户创建分析卡片
                for (const [index, entry] of addressEntries.entries()) {
                    const analysis = analyses[index]; // 获取对应地址的分析结果
                    
                    const accountCard = document.createElement('div');
                    accountCard.className = 'card mb-4';
                    accountCard.innerHTML = `
                        <div class="card-header bg-light">
                            <h5 class="mb-0">
                                <i class="bi bi-person-circle"></i> 
                                ${entry.name}
                                <small class="text-muted">${entry.address}</small>
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="stats-box bg-light">
                                        <h6 class="border-bottom pb-2">交易统计</h6>
                                        <div class="d-flex justify-content-between">
                                            <span>总交易次数:</span>
                                            <span class="fw-bold" id="totalTx_${index}"></span>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span>成功交易:</span>
                                            <span class="fw-bold" id="successTx_${index}"></span>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span>失败交易:</span>
                                            <span class="fw-bold" id="failedTx_${index}"></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="stats-box bg-light">
                                        <h6 class="border-bottom pb-2">交易金额</h6>
                                        <div class="d-flex justify-content-between">
                                            <span>买入总额:</span>
                                            <span class="fw-bold text-success" id="totalBuy_${index}"></span>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span>卖出总额:</span>
                                            <span class="fw-bold text-danger" id="totalSell_${index}"></span>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span>Gas消耗:</span>
                                            <span class="fw-bold" id="totalGas_${index}"></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="stats-box bg-light">
                                        <h6 class="border-bottom pb-2">收益分析</h6>
                                        <div class="d-flex justify-content-between">
                                            <span>交易盈亏:</span>
                                            <span class="fw-bold" id="profitLoss_${index}"></span>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span>净盈亏:</span>
                                            <span class="fw-bold" id="netProfitLoss_${index}"></span>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span>当前余额:</span>
                                            <span class="fw-bold" id="currentBalance_${index}"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4">
                                <div class="d-flex justify-content-between align-items-center border-bottom pb-2">
                                    <h6 class="mb-0">交易明细</h6>
                                    <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#tradesCollapse_${index}">
                                        <i class="bi bi-chevron-down"></i> 展开/收起
                                    </button>
                                </div>
                                <div class="collapse" id="tradesCollapse_${index}">
                                    <div class="pt-3" id="tradesContainer_${index}"></div>
                                </div>
                            </div>
                        </div>
                    `;
                    accountsContainer.appendChild(accountCard);

                    // 分析该账户的交易
                    const accountTransactions = analysis.trades;
                    console.log(`账户 ${entry.name} 分析结果包含 ${accountTransactions.length} 条交易`);
                    
                    // 计算该账户的统计数据
                    const accountStats = calculateAccountStats(accountTransactions, bnbPrice);
                    
                    // 更新账户统计数据显示
                    updateAccountStats(index, accountStats, bnbPrice, analysis.bnbBalance);
                    
                    // 渲染该账户的交易明细
                    renderAccountTrades(index, accountTransactions, bnbPrice);

                    // 在renderAccountTrades之后添加
                    if (analysis.unknownValueTrades && analysis.unknownValueTrades.length > 0) {
                        renderUnknownValueTrades(index, analysis.unknownValueTrades, bnbPrice);
                    }
                }
            }

            function calculateAccountStats(trades, bnbPrice) {
                const stats = {
                    totalTx: trades.length,
                    failedTx: 0,
                    totalBuyValue: 0,
                    totalSellValue: 0,
                    totalGasCost: 0,
                    totalGasCostUSD: 0,
                    profitLoss: 0,
                    netProfitLoss: 0
                };

                trades.forEach(trade => {
                    if (trade.type === 'buy') {
                        stats.totalBuyValue += trade.value;
                        stats.profitLoss -= trade.value;
                    } else {
                        stats.totalSellValue += trade.value;
                        stats.profitLoss += trade.value;
                    }
                    stats.totalGasCost += trade.gasCost;
                    stats.totalGasCostUSD += trade.gasCostUSD;
                });

                stats.netProfitLoss = stats.profitLoss - stats.totalGasCost;
                return stats;
            }

            function updateAccountStats(index, stats, bnbPrice, balance) {
                // 更新交易统计
                document.getElementById(`totalTx_${index}`).textContent = `${stats.totalTx} (失败: ${stats.failedTx})`;
                document.getElementById(`successTx_${index}`).textContent = stats.totalTx;
                document.getElementById(`failedTx_${index}`).textContent = stats.failedTx;

                // 更新交易金额 - 修改为显示BNB和美元
                document.getElementById(`totalBuy_${index}`).innerHTML = 
                    `${stats.totalBuyValue.toFixed(6)} BNB (<span class="text-muted">$${(stats.totalBuyValue * bnbPrice).toFixed(2)})</span>`;
                document.getElementById(`totalSell_${index}`).innerHTML = 
                    `${stats.totalSellValue.toFixed(6)} BNB (<span class="text-muted">$${(stats.totalSellValue * bnbPrice).toFixed(2)})</span>`;
                document.getElementById(`totalGas_${index}`).innerHTML = 
                    `${stats.totalGasCost.toFixed(6)} BNB (<span class="text-muted">$${stats.totalGasCostUSD.toFixed(2)})</span>`;

                // 更新收益分析
                const profitLossElem = document.getElementById(`profitLoss_${index}`);
                profitLossElem.innerHTML = 
                    `${stats.profitLoss.toFixed(6)} BNB (<span class="text-muted">$${(stats.profitLoss * bnbPrice).toFixed(2)})</span>`;
                profitLossElem.classList.add(stats.profitLoss >= 0 ? 'text-success' : 'text-danger');

                const netProfitLossElem = document.getElementById(`netProfitLoss_${index}`);
                netProfitLossElem.innerHTML = 
                    `${stats.netProfitLoss.toFixed(6)} BNB (<span class="text-muted">$${(stats.netProfitLoss * bnbPrice).toFixed(2)})</span>`;
                netProfitLossElem.classList.add(stats.netProfitLoss >= 0 ? 'text-success' : 'text-danger');

                // 更新当前余额
                document.getElementById(`currentBalance_${index}`).innerHTML = 
                    `${parseFloat(balance).toFixed(6)} BNB (<span class="text-muted">$${(parseFloat(balance) * bnbPrice).toFixed(2)})</span>`;
            }

            function renderAccountTrades(index, trades, bnbPrice) {
                const tradesContainer = document.getElementById(`tradesContainer_${index}`);
                tradesContainer.innerHTML = '';

                // 对交易按时间倒序排列
                const sortedTrades = [...trades].sort((a, b) => {
                    return new Date(b.timestamp) - new Date(a.timestamp);
                });

                sortedTrades.forEach(trade => {
                    const tradeCard = document.createElement('div');
                    tradeCard.className = `card trade-card ${trade.type === 'buy' ? 'buy-card' : 'sell-card'}`;
                    
                    tradeCard.innerHTML = `
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-title mb-0">
                                        <i class="bi ${trade.type === 'buy' ? 'bi-arrow-down-circle-fill text-success' : 'bi-arrow-up-circle-fill text-danger'}"></i>
                                        ${trade.type === 'buy' ? '买入' : '卖出'} - ${trade.dex}
                                    </h6>
                                    <div class="mt-2">
                                        <div class="d-flex align-items-center">
                                            <span>交易金额:</span>
                                            <span class="ms-2 fw-bold ${trade.type === 'buy' ? 'text-success' : 'text-danger'}">
                                                ${trade.value.toFixed(6)} BNB
                                                <span class="text-muted">($${(trade.value * bnbPrice).toFixed(2)})</span>
                                            </span>
                                        </div>
                                        <div class="d-flex align-items-center mt-1">
                                            <span>Gas 费用:</span>
                                            <span class="ms-2">
                                                ${trade.gasCost.toFixed(6)} BNB
                                                <span class="text-muted">($${trade.gasCostUSD.toFixed(2)})</span>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-end">
                                    <div class="text-muted mb-2">${trade.timestamp}</div>
                                    <a href="https://bscscan.com/tx/${trade.hash}" target="_blank" class="btn btn-sm btn-outline-secondary">
                                        <i class="bi bi-box-arrow-up-right"></i> 查看交易
                                    </a>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    tradesContainer.appendChild(tradeCard);
                });
            }

            function renderUnknownValueTrades(index, unknownTrades, bnbPrice) {
                if (!unknownTrades || unknownTrades.length === 0) return;
                
                // 创建一个新的容器
                const container = document.createElement('div');
                container.className = 'mt-4';
                container.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center border-bottom pb-2">
                        <h6 class="mb-0">未计入统计的交易 (${unknownTrades.length})</h6>
                        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#unknownTradesCollapse_${index}">
                            <i class="bi bi-chevron-down"></i> 展开/收起
                        </button>
                    </div>
                    <div class="collapse" id="unknownTradesCollapse_${index}">
                        <div class="alert alert-warning mt-2">
                            <i class="bi bi-exclamation-triangle"></i> 
                            以下交易无法确定交易价值，未计入统计数据
                        </div>
                        <div class="pt-2" id="unknownTradesContainer_${index}"></div>
                    </div>
                `;
                
                // 将容器添加到账户卡片
                const accountCard = document.querySelector(`#tradesCollapse_${index}`).closest('.card-body');
                accountCard.appendChild(container);
                
                // 渲染未知价值交易
                const tradesContainer = document.getElementById(`unknownTradesContainer_${index}`);
                
                // 对交易按时间倒序排列
                const sortedTrades = [...unknownTrades].sort((a, b) => {
                    return new Date(b.timestamp) - new Date(a.timestamp);
                });
                
                sortedTrades.forEach(trade => {
                    const tradeCard = document.createElement('div');
                    tradeCard.className = 'card trade-card border-warning';
                    
                    tradeCard.innerHTML = `
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-title mb-0">
                                        <i class="bi bi-question-circle text-warning"></i>
                                        未知价值交易 - ${trade.dex}
                                    </h6>
                                    <div class="mt-2">
                                        <div class="d-flex align-items-center">
                                            <span>代币地址:</span>
                                            <span class="ms-2">
                                                ${trade.tokenAddress || '未知'}
                                            </span>
                                        </div>
                                        <div class="d-flex align-items-center mt-1">
                                            <span>Gas 费用:</span>
                                            <span class="ms-2">
                                                ${trade.gasCost.toFixed(6)} BNB
                                                <span class="text-muted">($${(trade.gasCost * bnbPrice).toFixed(2)})</span>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-end">
                                    <div class="text-muted mb-2">${trade.timestamp}</div>
                                    <a href="https://bscscan.com/tx/${trade.hash}" target="_blank" class="btn btn-sm btn-outline-secondary">
                                        <i class="bi bi-box-arrow-up-right"></i> 查看交易
                                    </a>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    tradesContainer.appendChild(tradeCard);
                });
            }

            // 修改checkInternalTransactions函数，添加web3参数
            async function checkInternalTransactions(txHash, address, internalTxCache, web3) {
                try {
                    if (internalTxCache && internalTxCache[txHash]) {
                        const cachedData = internalTxCache[txHash];
                        if (cachedData.status === '1' && Array.isArray(cachedData.result)) {
                            for (const internalTx of cachedData.result) {
                                if (internalTx.to.toLowerCase() === address.toLowerCase()) {
                                    return parseFloat(web3.utils.fromWei(internalTx.value, 'ether'));
                                }
                            }
                        }
                        return 0;
                    }
                    
                    const API_KEY = 'IQ3RMA9IIBCAE4ITKUXCBATEQ3D9R2TKRP';
                    const internalTxUrl = `https://api.bscscan.com/api?module=account&action=txlistinternal&txhash=${txHash}&apikey=${API_KEY}`;
                    const internalResponse = await fetch(internalTxUrl);
                    const internalData = await internalResponse.json();
                    
                    // 如果提供了缓存对象，就存入缓存
                    if (internalTxCache) {
                        internalTxCache[txHash] = internalData;
                    }
                    
                    if (internalData.status === '1' && Array.isArray(internalData.result)) {
                        for (const internalTx of internalData.result) {
                            if (internalTx.to.toLowerCase() === address.toLowerCase()) {
                                return parseFloat(web3.utils.fromWei(internalTx.value, 'ether'));
                            }
                        }
                    }
                    return 0;
                } catch (e) {
                    console.error(`获取内部交易失败:`, e);
                    return 0;
                }
            }

            // 修改analyzeTransactions函数，添加数据持久化功能
            async function analyzeTransactions(addressInfo, transactions, timeRange, bnbPrice, bnbBalance) {
                // 生成唯一的缓存键
                const cacheKey = `bsc_analysis_${addressInfo.address.substring(0, 8)}_${new Date().toISOString().substring(0, 19)}`;
                
                // 检查是否有缓存数据
                let cachedData = null;
                try {
                    const cachedString = localStorage.getItem(cacheKey);
                    if (cachedString) {
                        cachedData = JSON.parse(cachedString);
                        console.log(`发现缓存数据，从第${cachedData.processedCount}条交易恢复`);
                    }
                } catch (e) {
                    console.warn('读取缓存数据失败:', e);
                }
                
                // 定义特殊地址
                const SPECIAL_ADDRESSES = [
                    '0x5efc784d444126ecc05f22c49ff3fbd7d9f4868a'.toLowerCase(),
                    '0xde9e4FE32B049f821c7f3e9802381aa470FFCA73'.toLowerCase()
                ];
                
                // 如果有缓存数据，使用缓存的分析结果
                const analysis = cachedData?.analysis || {
                    name: addressInfo.name,
                    address: addressInfo.address,
                    totalTx: 0,
                    totalGasUsed: 0,
                    totalGasCost: 0,
                    totalGasCostUSD: 0,
                    trades: [],
                    totalBuyValue: 0,
                    totalSellValue: 0,
                    profitLoss: 0,
                    netProfitLoss: 0,
                    bnbPrice: bnbPrice,
                    failedTx: 0,
                    bnbBalance: parseFloat(bnbBalance),
                    timeRange: timeRange,
                    unknownValueTrades: []
                };
                
                // 添加这三个缺失的变量定义
                const receiptsCache = cachedData?.receiptsCache || {};
                const internalTxCache = cachedData?.internalTxCache || {};
                const failedTxs = cachedData?.failedTxs || [];
                
                const web3 = new Web3('https://bsc-dataseed.binance.org/');
                
                // 过滤指定时间范围内的交易
                // 严格过滤，确保只处理当前地址的交易
                const filteredTransactions = transactions.filter(tx => {
                    const txTime = parseInt(tx.timeStamp);
                    const isCorrectTimeRange = txTime >= timeRange.startTimestamp && txTime <= timeRange.endTimestamp;
                    
                    // 检查交易是否属于当前地址 - 更严格的检查
                    const isRelatedToAddress = tx.ownerAddress === addressInfo.address.toLowerCase() || 
                                             (tx.from.toLowerCase() === addressInfo.address.toLowerCase() || 
                                              tx.to.toLowerCase() === addressInfo.address.toLowerCase());
                    
                    return isCorrectTimeRange && isRelatedToAddress;
                });
                
                console.log(`地址 ${addressInfo.name} (${addressInfo.address}) 在选定时间范围内有 ${filteredTransactions.length} 条交易`);
                
                // 显示处理进度
                const totalTxs = filteredTransactions.length;
                document.getElementById('loading-detail').textContent = `分析 ${addressInfo.name} 的交易: 0/${totalTxs}`;
                document.querySelector('.loading-progress-bar').style.width = '0%';
                
                for (let i = 0; i < filteredTransactions.length; i++) {
                    const progress = Math.min(100, Math.round((i / totalTxs) * 100));
                    document.getElementById('loading-detail').textContent = `分析 ${addressInfo.name} 的交易: ${i+1}/${totalTxs}`;
                    document.querySelector('.loading-progress-bar').style.width = `${progress}%`;
                    
                    const tx = filteredTransactions[i];
                    
                    try {
                        if (tx.isError === "1") {
                            analysis.failedTx++;
                            continue;
                        }
                        
                        const to = tx.to.toLowerCase();
                        const from = tx.from.toLowerCase();
                        
                        // 获取methodId
                        const methodId = tx.input && tx.input.length >= 10 ? tx.input.substring(0, 10).toLowerCase() : '';
                        
                        // 检查是否是DEX路由或聚合器交易
                        const isDexRouter = Object.values(routerAddresses).includes(to);
                        const is1inch = is1inchMethod(tx.input);
                        
                        if (!isDexRouter && !is1inch) {
                            continue; // 不是DEX相关交易，跳过
                        }
                        
                        // 确定DEX名称
                        let dex = '未知DEX';
                        if (isDexRouter) {
                            dex = Object.keys(routerAddresses).find(key => routerAddresses[key] === to) || '未知DEX';
                        } else if (is1inch) {
                            dex = '1inch';
                        }
                            
                        // 计算gas费用
                        let gasCost = '0', gasCostUSD = 0;
                        try {
                            if (tx.gasUsed && tx.gasPrice) {
                                // 确保两个值都存在并且不是空字符串
                                const gasUsed = tx.gasUsed.toString() || '0';
                                const gasPrice = tx.gasPrice.toString() || '0';
                                
                                // 只有当两个值都有效时才计算
                                if (gasUsed !== '0' && gasPrice !== '0') {
                                    gasCost = web3.utils.fromWei((BigInt(gasUsed) * BigInt(gasPrice)).toString(), 'ether');
                                    gasCostUSD = parseFloat(gasCost) * bnbPrice;
                                }
                            }
                        } catch (e) {
                            console.warn(`计算gas费用失败: ${tx.hash}`, e);
                            gasCost = '0';
                            gasCostUSD = 0;
                        }
                        
                        // 从缓存获取或请求交易收据
                        let receipt;
                        if (receiptsCache[tx.hash]) {
                            receipt = receiptsCache[tx.hash];
                        } else {
                            receipt = await web3.eth.getTransactionReceipt(tx.hash);
                            receiptsCache[tx.hash] = receipt; // 缓存收据
                        }
                        
                        // 生成人类可读的时间戳
                        const timestamp = new Date(parseInt(tx.timeStamp) * 1000).toLocaleString('zh-CN', {
                            timeZone: 'Asia/Shanghai',
                            year: 'numeric', month: '2-digit', day: '2-digit',
                            hour: '2-digit', minute: '2-digit', second: '2-digit'
                        });

                        // 使用通用解析方法
                        const parsedTx = await parseTransaction(tx, receipt, addressInfo, internalTxCache);
                        
                        // 根据解析结果处理
                        if (parsedTx.type === 'buy') {
                            // 买入交易
                            analysis.totalBuyValue += parsedTx.value;
                            analysis.profitLoss -= parsedTx.value;
                                
                            analysis.trades.push({
                                type: 'buy',
                                hash: tx.hash,
                                timestamp: timestamp,
                                value: parsedTx.value,
                                gasCost: parseFloat(gasCost),
                                gasCostUSD: gasCostUSD,
                                dex: dex,
                                accountName: tx.accountName,
                                tokenAddress: parsedTx.tokenAddress,
                                certainty: parsedTx.certainty,
                                note: `${methodId} 买入交易`
                            });
                            console.log(`记录买入交易: ${tx.hash}, 金额: ${parsedTx.value} BNB`);
                            
                        } else if (parsedTx.type === 'sell') {
                            // 卖出交易
                            analysis.totalSellValue += parsedTx.value;
                            analysis.profitLoss += parsedTx.value;
                                
                            analysis.trades.push({
                                type: 'sell',
                                hash: tx.hash,
                                timestamp: timestamp,
                                value: parsedTx.value,
                                gasCost: parseFloat(gasCost),
                                gasCostUSD: gasCostUSD,
                                dex: dex,
                                accountName: tx.accountName,
                                tokenAddress: parsedTx.tokenAddress,
                                certainty: parsedTx.certainty,
                                note: `${methodId} 卖出交易`
                            });
                            console.log(`记录卖出交易: ${tx.hash}, 金额: ${parsedTx.value} BNB`);
                            
                        } else {
                            // 未知交易类型
                            if (!analysis.unknownValueTrades) analysis.unknownValueTrades = [];
                            analysis.unknownValueTrades.push({
                                hash: tx.hash,
                                timestamp: timestamp,
                                tokenAddress: parsedTx.tokenAddress,
                                tokenOutAddress: parsedTx.tokenOutAddress,
                                dex: dex,
                                accountName: tx.accountName,
                                gasCost: parseFloat(gasCost),
                                methodId: methodId,
                                note: '无法确定价值的交易'
                            });
                            console.log(`记录未知交易: ${tx.hash}`);
                            
                            // 继续处理下一个交易
                            continue;
                        }
                        
                        // 统计gas费用
                        analysis.totalGasCost += parseFloat(gasCost);
                        analysis.totalGasCostUSD += gasCostUSD;
                        analysis.totalTx += 1;
                        
                        // 定期保存缓存数据，每5条交易保存一次
                        if (i % 5 === 0 || i === filteredTransactions.length - 1) {
                            try {
                                const cacheData = {
                                    analysis: analysis,
                                    processedCount: i + 1,
                                    receiptsCache: receiptsCache,
                                    internalTxCache: internalTxCache,
                                    failedTxs: failedTxs,
                                    timestamp: new Date().toISOString()
                                };
                                
                                localStorage.setItem(cacheKey, JSON.stringify(cacheData));
                                console.log(`已缓存分析结果至第${i+1}/${filteredTransactions.length}条交易`);
                            } catch (e) {
                                console.warn('缓存分析结果失败:', e);
                            }
                        }
                        
                        // 检查是否是proxySwapV2交易
                        if (tx.input && tx.input.length >= 10 && tx.input.substring(0, 10).toLowerCase() === '0xe5e8894b') {
                            console.log(`发现proxySwapV2交易: ${tx.hash}`);
                            
                            // 增加日志输出，帮助调试
                            const logs = await web3.eth.getTransactionReceipt(tx.hash).then(r => r.logs);
                            const usdtLogs = logs.filter(log => {
                                // 这里可以添加USDT合约地址的检查
                                return log.topics && log.topics[0] === '0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef';
                            });
                            
                            console.log(`proxySwapV2交易 ${tx.hash} 有 ${usdtLogs.length} 个转账事件`);
                            
                            // 增加针对此方法的特殊调试输出
                            console.log(`交易详情:`, {
                                hash: tx.hash,
                                from: tx.from,
                                to: tx.to,
                                value: tx.value,
                                methodId: tx.input.substring(0, 10),
                                hasLogs: logs.length > 0
                            });
                        }
                        
                        // 添加对proxySwap方法的监控
                        if (tx.input && tx.input.length >= 10 && tx.input.substring(0, 10).toLowerCase() === '0xdad12b6c') {
                            console.log(`发现proxySwap交易: ${tx.hash}`);
                            
                            // 增加日志输出，帮助调试
                            const logs = await web3.eth.getTransactionReceipt(tx.hash).then(r => r.logs);
                            const transferLogs = logs.filter(log => {
                                return log.topics && log.topics[0] === '0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef';
                            });
                            
                            console.log(`proxySwap交易 ${tx.hash} 有 ${transferLogs.length} 个转账事件`);
                            
                            // 记录交易详情
                            console.log(`proxySwap交易详情:`, {
                                hash: tx.hash,
                                from: tx.from,
                                to: tx.to,
                                value: tx.value,
                                methodId: tx.input.substring(0, 10),
                                hasLogs: logs.length > 0
                            });
                        }
                        
                        // 添加更详细的日志输出
                        if (parsedTx.type === 'buy' || parsedTx.type === 'sell') {
                            console.log(`交易 ${tx.hash} 被识别为 ${parsedTx.type} 交易:`, {
                                type: parsedTx.type,
                                value: parsedTx.value,
                                tokenAddress: parsedTx.tokenAddress,
                                certainty: parsedTx.certainty,
                                methodId: methodId
                            });
                        } else {
                            console.log(`交易 ${tx.hash} 未被识别: methodId=${methodId}`);
                        }
                        
                        // 添加一个针对特定交易哈希的日志输出，以便调试
                        if (tx.hash.toLowerCase() === '0x85cc50bfa8ebba2833f7311a0fd6530c2fff00024280638d5ccde55d748d9683'.toLowerCase()) {
                            console.log(`[特别关注] 发现特定交易: ${tx.hash}, 方法ID: ${methodId}`);
                            console.log(`[特别关注] 交易特征:`, {
                                valueOut: traits.valueOut,
                                wbnbOut: traits.wbnbOut, 
                                wbnbOutAmount: traits.wbnbOutAmount,
                                wbnbIn: traits.wbnbIn,
                                wbnbInAmount: traits.wbnbInAmount,
                                internalBnbIn: traits.internalBnbIn,
                                otherTokenOut: traits.otherTokenOut,
                                otherTokenOutContract: traits.otherTokenOutContract,
                                otherTokenIn: traits.otherTokenIn,
                                otherTokenInContract: traits.otherTokenInContract
                            });
                        }
                        
                    } catch (error) {
                        console.error(`处理交易错误 (${i+1}/${filteredTransactions.length}):`, error);
                        failedTxs.push({
                            hash: tx.hash,
                            index: i,
                            error: error.message
                        });
                        
                        // 即使出错也保存当前进度
                        try {
                            const cacheData = {
                                analysis: analysis,
                                processedCount: i + 1,
                                receiptsCache: receiptsCache,
                                internalTxCache: internalTxCache,
                                failedTxs: failedTxs,
                                timestamp: new Date().toISOString()
                            };
                            
                            localStorage.setItem(cacheKey, JSON.stringify(cacheData));
                            console.log(`出错后已缓存分析结果至第${i+1}/${filteredTransactions.length}条交易`);
                        } catch (e) {
                            console.warn('缓存分析结果失败:', e);
                        }
                        
                        continue;
                    }
                }
                
                // 分析完成后，清除缓存
                try {
                    analysis.netProfitLoss = analysis.profitLoss - analysis.totalGasCost;
                    
                    // 保存最终结果
                    localStorage.setItem(`${cacheKey}_final`, JSON.stringify({
                        analysis: analysis,
                        timestamp: new Date().toISOString(),
                        failedTxs: failedTxs
                    }));
                    
                    console.log(`分析完成，总共处理了${filteredTransactions.length}条交易，有${failedTxs.length}条失败`);
                    
                    // 保留最终结果，但清除中间缓存
                    localStorage.removeItem(cacheKey);
                } catch (e) {
                    console.warn('清除缓存失败:', e);
                }
                
                return analysis;
            }

            // 添加一个动态估算交易价值的通用函数
            function estimateTransactionValue(tx, gasCost, type) {
                const gasUsed = parseFloat(tx.gasUsed) || 0;
                const gasFee = parseFloat(gasCost) || 0;
                let estimatedValue;
                
                // 基于gas费用估算
                if (gasFee > 0) {
                    // 买入和卖出交易的估算倍数可能不同
                    const multiplier = type === 'sell' 
                        ? (gasUsed > 500000 ? 50 : gasUsed > 200000 ? 30 : 20)
                        : (gasUsed > 500000 ? 40 : gasUsed > 200000 ? 25 : 15);
                    
                    estimatedValue = gasFee * multiplier;
                } 
                // 回退到基于gas使用量的估算
                else {
                    const divisor = type === 'sell'
                        ? (gasUsed > 500000 ? 2e6 : gasUsed > 200000 ? 3e6 : 4e6)
                        : (gasUsed > 500000 ? 2.5e6 : gasUsed > 200000 ? 3.5e6 : 5e6);
                    
                    estimatedValue = gasUsed / divisor;
                }
                
                // 确保值是有效的
                return isFinite(estimatedValue) && estimatedValue > 0 ? estimatedValue : gasUsed / 5e6;
            }
        });
    </script>
</body>
</html>
